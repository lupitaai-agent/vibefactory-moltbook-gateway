name: Post to Moltbook

on:
  repository_dispatch:
    types: [moltbook_post]

  workflow_dispatch:
    inputs:
      mode:
        description: "post | comment"
        required: true
      submolt:
        description: "Submolt/community (for posts)"
        required: false
      title:
        description: "Post title (for posts)"
        required: false
      content:
        description: "Content (for posts/comments)"
        required: true
      post_id:
        description: "Post ID (for comments)"
        required: false

concurrency:
  group: moltbook
  cancel-in-progress: true

jobs:
  moltbook:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Resolve inputs (agent-driven)
        env:
          MODE: ${{ github.event.client_payload.mode || inputs.mode }}
          SUBMOLT: ${{ github.event.client_payload.submolt || inputs.submolt }}
          TITLE: ${{ github.event.client_payload.title || inputs.title }}
          CONTENT: ${{ github.event.client_payload.content || inputs.content }}
          POST_ID: ${{ github.event.client_payload.post_id || inputs.post_id }}
        run: |
          # Normalize whitespace
          MODE="$(echo -n "${MODE}" | xargs)"
          SUBMOLT="$(echo -n "${SUBMOLT}" | xargs)"
          TITLE="$(echo -n "${TITLE}" | xargs)"
          CONTENT="$(echo -n "${CONTENT}" | xargs)"
          POST_ID="$(echo -n "${POST_ID}" | xargs)"

          echo "MODE=$MODE" >> $GITHUB_ENV
          echo "SUBMOLT=$SUBMOLT" >> $GITHUB_ENV
          echo "TITLE=$TITLE" >> $GITHUB_ENV
          echo "CONTENT=$CONTENT" >> $GITHUB_ENV
          echo "POST_ID=$POST_ID" >> $GITHUB_ENV

          echo "Resolved:"
          echo "  mode=$MODE"
          echo "  submolt=$SUBMOLT"
          echo "  title=(len ${#TITLE})"
          echo "  content=(len ${#CONTENT})"
          echo "  post_id=$POST_ID"

      - name: Post to Moltbook (no hard-coded content)
        env:
          MOLTBOOK_API_KEY: ${{ secrets.MOLTBOOK_API_KEY }}
        run: |
          set -e

          if [ -z "${MOLTBOOK_API_KEY}" ]; then
            echo "ERROR: MOLTBOOK_API_KEY secret is empty or missing."
            exit 1
          fi

          if [ -z "${MODE}" ]; then
            echo "ERROR: mode is required ('post' or 'comment')."
            exit 1
          fi

          if [ "${MODE}" = "post" ]; then
            # Strict validation: must be supplied by agents (or manual input)
            if [ -z "${SUBMOLT}" ]; then
              echo "ERROR: submolt is required for post mode."
              exit 1
            fi
            if [ -z "${TITLE}" ]; then
              echo "ERROR: title is required for post mode."
              exit 1
            fi
            if [ -z "${CONTENT}" ]; then
              echo "ERROR: content is required for post mode."
              exit 1
            fi

            jq -n \
              --arg submolt "${SUBMOLT}" \
              --arg title "${TITLE}" \
              --arg content "${CONTENT}" \
              '{submolt:$submolt, title:$title, content:$content}' > request.json

            echo "Posting to Moltbook /api/v1/posts ..."
            http_code=$(curl -sS --fail-with-body \
              -o response.json \
              -w "%{http_code}" \
              -X POST "https://www.moltbook.com/api/v1/posts" \
              -H "Authorization: Bearer ${MOLTBOOK_API_KEY}" \
              -H "Content-Type: application/json" \
              -d @request.json) || {
                echo "ERROR: curl failed."
                echo "Response body:"
                cat response.json || true
                exit 1
              }

          elif [ "${MODE}" = "comment" ]; then
            # NOTE: endpoint may differ; update once confirmed by Moltbook docs.
            if [ -z "${POST_ID}" ]; then
              echo "ERROR: post_id is required for comment mode."
              exit 1
            fi
            if [ -z "${CONTENT}" ]; then
              echo "ERROR: content is required for comment mode."
              exit 1
            fi

            jq -n \
              --arg post_id "${POST_ID}" \
              --arg content "${CONTENT}" \
              '{post_id:$post_id, content:$content}' > request.json

            echo "Commenting to Moltbook /api/v1/comments ..."
            http_code=$(curl -sS --fail-with-body \
              -o response.json \
              -w "%{http_code}" \
              -X POST "https://www.moltbook.com/api/v1/comments" \
              -H "Authorization: Bearer ${MOLTBOOK_API_KEY}" \
              -H "Content-Type: application/json" \
              -d @request.json) || {
                echo "ERROR: curl failed."
                echo "Response body:"
                cat response.json || true
                exit 1
              }

          else
            echo "ERROR: Unknown mode '${MODE}'. Use 'post' or 'comment'."
            exit 1
          fi

          echo "HTTP status: ${http_code}"
          echo "Response body:"
          cat response.json

          if [ "${http_code}" -lt 200 ] || [ "${http_code}" -ge 300 ]; then
            echo "ERROR: Moltbook returned non-2xx."
            exit 1
          fi

          echo "âœ… Moltbook action successful."
