name: Lovable Deploy Bridge

on:
  repository_dispatch:
    types: [lovable_build]

concurrency:
  group: lovable-build
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Validate payload
        env:
          TASK_ID: ${{ github.event.client_payload.task_id }}
          PROMPT: ${{ github.event.client_payload.prompt }}
        run: |
          set -e
          if [ -z "$TASK_ID" ]; then
            echo "ERROR: client_payload.task_id missing"
            exit 1
          fi
          if [ -z "$PROMPT" ]; then
            echo "ERROR: client_payload.prompt missing"
            exit 1
          fi
          echo "OK: task_id=$TASK_ID, prompt_len=${#PROMPT}"

      - name: Report status (executing)
        env:
          URL: ${{ secrets.LOVABLE_WEBHOOK_URL }}
          TOKEN: ${{ secrets.LOVABLE_WEBHOOK_TOKEN }}
          TASK_ID: ${{ github.event.client_payload.task_id }}
        run: |
          set -e
          curl -sS --fail-with-body -X POST "$URL" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg task_id "$TASK_ID" \
              --arg status "executing" \
              --arg run_id "${{ github.run_id }}" \
              --arg repo "${{ github.repository }}" \
              '{task_id:$task_id,status:$status,run_id:$run_id,repo:$repo}')"

      - name: Trigger Lovable build (Build URL)
        env:
          LOVABLE_BUILD_URL: ${{ secrets.LOVABLE_BUILD_URL }}
          PROMPT: ${{ github.event.client_payload.prompt }}
        run: |
          set -e
          if [ -z "$LOVABLE_BUILD_URL" ]; then
            echo "ERROR: LOVABLE_BUILD_URL secret missing"
            exit 1
          fi

          # POST prompt to Lovable Build URL
          curl -sS --fail-with-body -X POST "$LOVABLE_BUILD_URL" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg prompt "$PROMPT" '{prompt:$prompt}')"

      - name: Report status (done)
        if: success()
        env:
          URL: ${{ secrets.LOVABLE_WEBHOOK_URL }}
          TOKEN: ${{ secrets.LOVABLE_WEBHOOK_TOKEN }}
          TASK_ID: ${{ github.event.client_payload.task_id }}
        run: |
          set -e
          curl -sS --fail-with-body -X POST "$URL" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg task_id "$TASK_ID" \
              --arg status "done" \
              --arg run_id "${{ github.run_id }}" \
              --arg repo "${{ github.repository }}" \
              '{task_id:$task_id,status:$status,run_id:$run_id,repo:$repo}')"

      - name: Report status (failed)
        if: failure()
        env:
          URL: ${{ secrets.LOVABLE_WEBHOOK_URL }}
          TOKEN: ${{ secrets.LOVABLE_WEBHOOK_TOKEN }}
          TASK_ID: ${{ github.event.client_payload.task_id }}
        run: |
          # best-effort; don't fail twice
          curl -sS -X POST "$URL" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg task_id "$TASK_ID" \
              --arg status "failed" \
              --arg run_id "${{ github.run_id }}" \
              --arg repo "${{ github.repository }}" \
              '{task_id:$task_id,status:$status,run_id:$run_id,repo:$repo}')" || true
