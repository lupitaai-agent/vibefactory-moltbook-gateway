name: Lovable Deploy Bridge

on:
  repository_dispatch:
    types: [lovable_build]

concurrency:
  group: lovable-build
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Validate payload
        env:
          TASK_ID: ${{ github.event.client_payload.task_id }}
          PROMPT: ${{ github.event.client_payload.prompt }}
        run: |
          set -e
          if [ -z "$TASK_ID" ]; then
            echo "ERROR: client_payload.task_id missing"
            exit 1
          fi
          if [ -z "$PROMPT" ]; then
            echo "ERROR: client_payload.prompt missing"
            exit 1
          fi
          echo "Got task_id=$TASK_ID (prompt length: ${#PROMPT})"

      - name: Mark task executing (Lovable webhook)
        env:
          URL: ${{ secrets.LOVABLE_WEBHOOK_URL }}
          TOKEN: ${{ secrets.LOVABLE_WEBHOOK_TOKEN }}
          TASK_ID: ${{ github.event.client_payload.task_id }}
        run: |
          set -e
          curl -sS --fail-with-body -X POST "$URL" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"task_id\":\"$TASK_ID\",\"status\":\"executing\"}"

      - name: Trigger Lovable build
        env:
          LOVABLE_API_KEY: ${{ secrets.LOVABLE_API_KEY }}
          PROMPT: ${{ github.event.client_payload.prompt }}
        run: |
          set -e
          # NOTE: This endpoint must match what Lovable actually supports in your environment.
          # Replace URL and payload shape if your Lovable team gave you a different endpoint.
          curl -sS --fail-with-body -X POST "https://api.lovable.dev/v1/build" \
            -H "Authorization: Bearer ${LOVABLE_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg prompt "$PROMPT" '{prompt:$prompt}')"
        shell: bash

      - name: Mark task done (Lovable webhook)
        if: success()
        env:
          URL: ${{ secrets.LOVABLE_WEBHOOK_URL }}
          TOKEN: ${{ secrets.LOVABLE_WEBHOOK_TOKEN }}
          TASK_ID: ${{ github.event.client_payload.task_id }}
        run: |
          set -e
          curl -sS --fail-with-body -X POST "$URL" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"task_id\":\"$TASK_ID\",\"status\":\"done\"}"

      - name: Mark task failed (Lovable webhook)
        if: failure()
        env:
          URL: ${{ secrets.LOVABLE_WEBHOOK_URL }}
          TOKEN: ${{ secrets.LOVABLE_WEBHOOK_TOKEN }}
          TASK_ID: ${{ github.event.client_payload.task_id }}
        run: |
          # Best-effort report
          curl -sS -X POST "$URL" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"task_id\":\"$TASK_ID\",\"status\":\"failed\"}" || true
